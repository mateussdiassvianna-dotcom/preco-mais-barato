<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Administrativo - Comerciantes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Segoe UI", sans-serif;
        }
        .scroll-card {
            max-height: 280px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        .card {
            border-radius: 12px;
            border: 1px solid #ddd;
        }
        .card-header-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .badge-status {
            font-size: 0.8rem;
            padding: 5px 8px;
        }
        .comerciante-foto {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid #e2e2e2;
        }
        .produto-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 10px;
        }
        .btn-sm {
            margin-left: 4px;
        }
        .list-group-item {
            background-color: #fff;
        }
        .list-group-item:hover {
            background-color: #f3f4f6;
        }
        .collapse.show {
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>
<body>

<div class="container mt-4 mb-5">
    <h2 class="mb-3">üì¶ Lista de Comerciantes</h2>
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary mb-4">‚¨Ö Voltar ao Dashboard</a>

    <!-- Filtro e busca -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2 mb-2">
            <button id="filtro-todos" class="btn btn-outline-primary btn-sm active">Todos</button>
            <button id="filtro-bloqueados" class="btn btn-outline-danger btn-sm">Bloqueados</button>
        </div>

        <div class="mb-2">
            <input type="text" id="busca" class="form-control form-control-sm" placeholder="Buscar por nome ou cidade..." style="width: 250px;">
        </div>
    </div>

    {% if comerciantes %}
        {% for c in comerciantes %}
        <div class="card mb-4 shadow-sm comerciante-card" 
             data-status="{{ c.get('status', 'desconhecido') }}" 
             data-nome="{{ c.get('nome', '').lower() }}" 
             data-cidade="{{ c.get('cidade', '').lower() }}">

            <!-- Cabe√ßalho -->
            <div class="card-header card-header-btn bg-light">
                <div class="d-flex align-items-center">
                    <img src="{{ c.get('foto') or '/static/img/sem-foto.jpg' }}" 
                         onerror="this.onerror=null;this.src='/static/img/sem-foto.jpg';"
                         class="comerciante-foto" 
                         alt="Foto do comerciante {{ c.get('nome', 'Sem nome') }}">
                    <div>
                        <strong>{{ c.get('nome', 'Sem nome') }}</strong><br>
                        <small class="text-muted">
                            {{ c.get('cidade', 'Cidade n√£o informada') }} - {{ c.get('estado', '') }}
                        </small><br>
                        
                        {% if c.get('status') == 'ativo' %}
                            <span class="badge bg-success badge-status">Ativo</span>
                        {% else %}
                            <span class="badge bg-secondary badge-status">
                                Bloqueado 
                                {% if c.get('data_bloqueio') %}
                                    <small class="text-light d-block mt-1" style="font-size: 0.7rem;">
                                        em {{ c['data_bloqueio'][:16] }}
                                    </small>
                                {% endif %}
                            </span>
                        {% endif %}
                    </div>
                </div>

                <div>
                    {% if c.get('status') == 'ativo' %}
                        <a href="{{ url_for('admin.admin_bloquear_comerciante', id=c['id']) }}" class="btn btn-danger btn-sm">Bloquear</a>
                    {% else %}
                        <a href="{{ url_for('admin.admin_desbloquear_comerciante', id=c['id']) }}" class="btn btn-success btn-sm">Desbloquear</a>
                    {% endif %}
                    <a href="{{ url_for('admin.admin_apagar_comerciante', id=c['id']) }}" 
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Tem certeza que deseja apagar este comerciante?')">Apagar</a>
                </div>
            </div>

            <!-- Corpo -->
            <div class="card-body">
                <p><strong>WhatsApp:</strong> {{ c.get('whatsapp', 'N√£o informado') }}</p>
                <p><strong>Endere√ßo:</strong> 
                    {{ c.get('endereco_logradouro', '') }}, {{ c.get('endereco_numero', '') }} 
                    {{ c.get('endereco_complemento', '') }}
                </p>

                <!-- PRODUTOS -->
                <p class="mt-3">
                    <strong>Produtos:</strong> {{ (c.get('produtos') or [])|length }}
                    {% if c.get('produtos') %}
                        <button class="btn btn-info btn-sm" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#produtos-{{ c['id'] }}"
                                aria-expanded="false" 
                                aria-controls="produtos-{{ c['id'] }}">
                            Ver Produtos
                        </button>
                    {% endif %}
                </p>

                {% if c.get('produtos') %}
                <div class="collapse scroll-card" id="produtos-{{ c['id'] }}">
                    <ul class="list-group list-group-flush">
                        {% for p in c['produtos'] %}
                        <li class="list-group-item d-flex align-items-center">
                            <img src="{{ p.get('imagem') or '/static/img/sem-produto.jpg' }}" 
                                 onerror="this.onerror=null;this.src='/static/img/sem-produto.jpg';"
                                 class="produto-img" 
                                 alt="Imagem do produto {{ p.get('nome', 'Sem nome') }}">
                            <div class="flex-grow-1">
                                <strong>{{ p.get('nome', 'Sem nome') }}</strong><br>
                                <small class="text-muted">{{ p.get('categoria', 'Sem categoria') }}</small>
                            </div>
                            <span class="fw-bold text-success">R$ {{ "%.2f"|format(p.get('preco', 0)) }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- HIST√ìRICO -->
                <p class="mt-3">
                    <strong>Hist√≥rico:</strong>
                    {% if c.get('historico') %}
                        <button class="btn btn-secondary btn-sm" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#historico-{{ c['id'] }}"
                                aria-expanded="false" 
                                aria-controls="historico-{{ c['id'] }}">
                            Ver Hist√≥rico
                        </button>
                    {% else %}
                        <span class="text-muted">Nenhum hist√≥rico registrado.</span>
                    {% endif %}
                </p>

                {% if c.get('historico') %}
                <div class="collapse scroll-card" id="historico-{{ c['id'] }}">
                    <ul class="list-group list-group-flush">
                        {% for h in c['historico'] %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ h.get('acao', 'A√ß√£o n√£o especificada') }}</span>
                            <small class="text-muted">
                                {{ h.get('data_hora')[:16] if h.get('data_hora') else 'Data desconhecida' }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- BOT√ÉO VER DETALHES -->
                <div class="mt-3">
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalComerciante{{ c['id'] }}">
                        Ver Detalhes
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DETALHES -->
        <div class="modal fade" id="modalComerciante{{ c['id'] }}" tabindex="-1" aria-labelledby="modalLabel{{ c['id'] }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalLabel{{ c['id'] }}">Detalhes do Comerciante - {{ c.get('nome') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex align-items-center mb-3">
                  <img src="{{ c.get('foto') or '/static/img/sem-foto.jpg' }}" 
                       class="comerciante-foto" alt="Foto de {{ c.get('nome') }}">
                  <div>
                    <strong>{{ c.get('nome') }}</strong><br>
                    <small>{{ c.get('cidade') }} - {{ c.get('estado') }}</small><br>
                    <span class="badge {{ 'bg-success' if c.get('status') == 'ativo' else 'bg-secondary' }}">
                      {{ c.get('status', 'desconhecido')|capitalize }}
                    </span>
                  </div>
                </div>
                <ul class="list-group">
                  <li class="list-group-item"><strong>Email:</strong> {{ c.get('email', 'N√£o informado') }}</li>
                  <li class="list-group-item"><strong>WhatsApp:</strong> {{ c.get('whatsapp', 'N√£o informado') }}</li>
                  <li class="list-group-item"><strong>Documento:</strong> {{ c.get('documento', 'N√£o informado') }}</li>
                  <li class="list-group-item"><strong>Endere√ßo:</strong> 
                      {{ c.get('endereco_logradouro', '') }}, {{ c.get('endereco_numero', '') }} - 
                      {{ c.get('endereco_bairro', '') }} - {{ c.get('cidade', '') }}/{{ c.get('estado', '') }}
                  </li>
                  <li class="list-group-item"><strong>CEP:</strong> {{ c.get('endereco_cep', 'N√£o informado') }}</li>
                  <li class="list-group-item"><strong>Complemento:</strong> {{ c.get('endereco_complemento', 'N√£o informado') }}</li>
                  <li class="list-group-item"><strong>Descri√ß√£o:</strong> {{ c.get('descricao', 'Sem descri√ß√£o') }}</li>
                  <li class="list-group-item"><strong>Data de cadastro:</strong> {{ c.get('data_cadastro', 'N√£o informada')[:16] }}</li>
                </ul>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info text-center">Nenhum comerciante cadastrado.</div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const filtroTodos = document.getElementById("filtro-todos");
    const filtroBloqueados = document.getElementById("filtro-bloqueados");
    const buscaInput = document.getElementById("busca");
    const cards = document.querySelectorAll(".comerciante-card");

    function filtrar() {
        const termo = buscaInput.value.toLowerCase();
        const mostrarBloqueados = filtroBloqueados.classList.contains("active");

        cards.forEach(card => {
            const status = card.dataset.status;
            const nome = card.dataset.nome;
            const cidade = card.dataset.cidade;
            const correspondeBusca = nome.includes(termo) || cidade.includes(termo);

            if ((mostrarBloqueados && status === "bloqueado" && correspondeBusca) ||
                (!mostrarBloqueados && correspondeBusca)) {
                card.style.display = "";
            } else {
                card.style.display = "none";
            }
        });
    }

    filtroTodos.addEventListener("click", () => {
        filtroTodos.classList.add("active");
        filtroBloqueados.classList.remove("active");
        filtrar();
    });

    filtroBloqueados.addEventListener("click", () => {
        filtroBloqueados.classList.add("active");
        filtroTodos.classList.remove("active");
        filtrar();
    });

    buscaInput.addEventListener("input", filtrar);
});
</script>

</body>
</html>
